# Настрйка работы с xv6 в Docker-контейнере

Для упрощения настройки окружения для разработки для xv6 может быть удобно
использовать Docker-контейнер. Особенно это удобно для пользователей Windows,
чтобы не придумывать, как установить себе в систему riscv-toolchain, и не
завязываться на WSL.

Для начала работы следует выполнить следующие шаги, они подробнее описаны
далее:

1. Установить Docker;
2. Получить образ контейнера для работы с xv6;
3. Запустить контейнер;
4. Собрать и запустить xv6;
5. Отладка xv6.

Разработка таким образом состоит в изменении исходных кодов каким-либо образом
(внутри контейнера или на хостовой системе) и тестировании и отладке запущенной ОС
внутри контейнера.

## Установка Docker

Для работы мы рекомендуем вам использовать [Docker](https://www.docker.com/),
установите его себе на компьютер по [инструкции от разработчиков](https://docs.docker.com/engine/install/).

## Образ для работы с xv6

При желании вы можете собрать образ самостоятельно, но для вашего удобстава
уже был составлен [Dockerfile](/ci/docker/Dockerfile) для создания подходящего
окружения (уже готовый
[vityamand/xv6](https://hub.docker.com/r/vityamand/xv6)). Образ собирается
стандартный образом, как это делается, можно видеть в
[build.sh](/ci/docker/build.sh).

Можете в качестве альтернативы использовать публичный образ
[wtakuo/xv6-env](https://hub.docker.com/r/wtakuo/xv6-env), который
рассматривался для разработки собственного. 

Предполагается монтировать директорию с исходными кодами xv6 в контейнер (опция
`-v`/`--volume`).

Краткое описание необходимых инструментов для разработки:
- системный эмулятор для архитектуры RISC-V (`qemu-sysytem-riscv`),
- компилятор под архитектуру RISC-V (`gcc-riscv-unknown-elf`),
- отладчик (`gdb-multiarch`),

Удобно так же использовать еще использовать следующие инструменты:
- мультиплексер терминала (`tmux`),
- утилита для создания compilation database (`bear`),
- language server (Clangd).

## Запуск контейнера

Контейнер с полученным образом нужно создать с флагами для монтирования внутрь
исходных кодов, например так:
```sh
docker run \
    --name xv6-env-ctnr-name
    -it \
    --volume $(pwd):/xv6 
    xv6-env-image-name /bin/bash
```
- где `xv6-env-ctnr-name` – имя контейнера на ваще усмотрение, а
  `xv6-env-image-name` – название образа, который вы собрали сами или скачали.
- может быть удобно добавить опцию `--rm` для автоматического удаления
  контейнера после его остановки.

Повторный запуск контейнера происходит командой `docker start`, подробнее см.
документацию к Docker.

## Cборка и запуск ОС xv6

`cd path/to/xv6/sources/`;

```sh
make qemu
```

```sh
make clean && bear -- make qemu
```

## Запуск xv6 с отладчиком

*add security setting to gdb config*

`tmux`

```sh
make qemu-gdb
```


